<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Apples-Mart - الماسح الضوئي المتطور</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f9fa;
    color: #222;
    direction: rtl;
    overflow-x: hidden;
  }
  
  .container {
    max-width: 100%;
    padding: 0;
  }
  
  /* تصميم الماسح الضوئي الجديد */
  #scanner-container {
    position: relative;
    width: 100vw;
    height: 40vh; /* ارتفاع يساوي نصف عرض الشاشة */
    background-color: #000;
    overflow: hidden;
    margin: 0;
    padding: 0;
    border: none;
  }
  
  #reader-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }
  
  #reader {
    width: 100%;
    height: 100%;
    background: #000;
    position: relative;
  }
  
  #reader::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    height: 60%;
    border: 10px solid #ff4747;
    box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.8);
    border-radius: 12px;
    pointer-events: none;
  }
  
  #scanner-controls {
    position: absolute;
    bottom: 15px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 10px;
    z-index: 100;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 25px;
    margin: 0 20px;
  }
  
  #closeScannerBtn {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 24px;
    line-height: 38px;
    padding: 0;
    text-align: center;
    cursor: pointer;
    z-index: 10;
  }
  
  #toggleFlashlightBtn {
    background-color: #444;
    color: white;
    border: 1px solid #666;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  #toggleFlashlightBtn.active {
    color: yellow;
    background-color: #554;
    border-color: yellow;
  }
  
  #cameraSelection {
    display: flex;
    gap: 10px;
    align-items: center;
    background: rgba(0, 0, 0, 0.6);
    padding: 8px 12px;
    border-radius: 20px;
  }
  
  #cameraSelection span {
    display: inline-block;
  }
  
  #cameraSelection input[type="radio"] {
    display: none;
  }
  
  #cameraSelection label {
    font-size: 12px;
    padding: 6px 10px;
    background-color: #444;
    border: 1px solid #666;
    border-radius: 15px;
    cursor: pointer;
    color: white;
    transition: all 0.2s;
  }
  
  #cameraSelection input[type="radio"]:checked + label {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
  }
  
  #zoomSliderContainer {
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    background: rgba(0, 0, 0, 0.6);
    padding: 8px 15px;
    border-radius: 20px;
  }
  
  #zoomSlider {
    width: 100px;
    direction: ltr;
  }
  
  .content-below {
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
  }
  
  .section-title {
    text-align: center;
    margin-bottom: 20px;
    color: #007bff;
    font-size: 24px;
  }
  
  .instructions {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .instructions h3 {
    color: #28a745;
    margin-bottom: 10px;
  }
  
  .instructions ul {
    padding-right: 20px;
  }
  
  .instructions li {
    margin-bottom: 8px;
  }
  
  .btn {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    text-decoration: none;
    text-align: center;
  }
  
  .btn:hover {
    background: #0056b3;
  }
  
  .btn-large {
    display: block;
    width: 100%;
    padding: 15px;
    font-size: 18px;
  }
  
  .btn-success {
    background: #28a745;
  }
  
  .btn-success:hover {
    background: #1e7e34;
  }
  
  .text-center {
    text-align: center;
  }
  
  .mt-20 {
    margin-top: 20px;
  }
  
  .notification-badge {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
  }
</style>
</head>
<body>

<!-- إشعار المسح الناجح -->
<div class="notification-badge" id="scanNotification">
  <i class="fas fa-check-circle"></i> تم مسح الباركود بنجاح
</div>

<div class="container">
  <!-- الماسح الضوئي في الأعلى -->
  <div id="scanner-container">
    <div id="reader-wrapper">
      <div id="reader"></div>
      <button id="closeScannerBtn">&times;</button>
    </div>
    <div id="scanner-controls">
      <div id="cameraSelection"></div>
      <div id="zoomSliderContainer">
        <i class="fas fa-search-minus"></i>
        <input type="range" id="zoomSlider" min="1" max="10" value="5" step="1">
        <i class="fas fa-search-plus"></i>
      </div>
      <button id="toggleFlashlightBtn"><i class="fas fa-bolt"></i></button>
    </div>
  </div>

  <!-- محتوى إضافي تحت الماسح -->
  <div class="content-below">
    <h2 class="section-title">ماسح الباركود المتطور</h2>
    
    <div class="instructions">
      <h3><i class="fas fa-info-circle"></i> تعليمات الاستخدام</h3>
      <ul>
        <li>ضع الباركود داخل الإطار المخصص في منتصف الشاشة</li>
        <li>تأكد من إضاءة كافية للتعرف على الباركود</li>
        <li>استخدم زر الكشاف (⚡) عندما تكون الإضاءة منخفضة</li>
        <li>استخدم زر الإغلاق (X) لإيقاف الماسح</li>
        <li>استخدم شريط التكبير/التقريب لضبط دقة المسح</li>
        <li>سيتم إشعارك عند كل مسح ناجح للباركود</li>
      </ul>
    </div>
    
    <div class="text-center mt-20">
      <button id="startScannerBtn" class="btn btn-large"><i class="fas fa-barcode"></i> تشغيل الماسح الضوئي</button>
    </div>
    
    <div class="instructions mt-20">
      <h3><i class="fas fa-history"></i> سجل المسح</h3>
      <p>سيظهر هنا سجل الباركود الذي تم مسحه</p>
      <ul id="scanHistory">
        <li>لا توجد عمليات مسح بعد</li>
      </ul>
    </div>
  </div>
</div>

<script>
// تهيئة مكتبة الإشعارات
const notyf = new Notyf({
  duration: 3000,
  position: {
    x: 'center',
    y: 'top',
  },
  types: [
    {
      type: 'success',
      background: '#28a745',
      icon: {
        className: 'fas fa-check-circle',
        tagName: 'i',
        text: ''
      }
    }
  ]
});

// متغيرات التطبيق
let html5QrCode = null;
let cameraTrack = null;
let isFlashOn = false;
let scanHistory = [];
let currentZoom = 1;

// عناصر DOM
const scannerContainer = document.getElementById('scanner-container');
const startScannerBtn = document.getElementById('startScannerBtn');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const toggleFlashlightBtn = document.getElementById('toggleFlashlightBtn');
const cameraSelection = document.getElementById('cameraSelection');
const scanHistoryList = document.getElementById('scanHistory');
const zoomSlider = document.getElementById('zoomSlider');
const scanNotification = document.getElementById('scanNotification');

// تهيئة الماسح الضوئي
function initScanner() {
  scannerContainer.style.display = 'block';
  startScannerBtn.style.display = 'none';
  
  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
  }
  
  // تهيئة قائمة الكاميرات
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      const backCameras = cameras.filter(camera => camera.label.toLowerCase().includes('back'));
      const camerasToUse = backCameras.length > 0 ? backCameras : cameras;
      
      cameraSelection.innerHTML = '';
      
      camerasToUse.forEach((camera, index) => {
        const radioId = `cam_${index}`;
        let name = `كاميرا ${index + 1}`;
        if (camera.label.toLowerCase().includes('back')) name += ' (خلفية)';
        if (camera.label.toLowerCase().includes('front')) name += ' (أمامية)';
        
        cameraSelection.innerHTML += `
          <span>
            <input type="radio" name="camera-select" id="${radioId}" value="${camera.id}" ${index === 0 ? 'checked' : ''}>
            <label for="${radioId}">${name}</label>
          </span>
        `;
      });
      
      // إضافة مستمعي الأحداث للكاميرات
      document.querySelectorAll('input[name="camera-select"]').forEach(radio => {
        radio.addEventListener('change', (event) => {
          if (event.target.checked) {
            startScanning(event.target.value);
          }
        });
      });
      
      // بدء المسح بالكاميرا الأولى
      startScanning(camerasToUse[0].id);
    }
  }).catch(err => {
    console.error("خطأ في الحصول على الكاميرات:", err);
    startScanning({ facingMode: "environment" });
  });
}

// بدء المسح
function startScanning(cameraId) {
  if (html5QrCode && html5QrCode.isScanning) {
    html5QrCode.stop().then(() => {
      startCamera(cameraId);
    }).catch(err => {
      console.error("خطأ في إيقاف الماسح:", err);
      startCamera(cameraId);
    });
  } else {
    startCamera(cameraId);
  }
}

// تشغيل الكاميرا
function startCamera(cameraId) {
  html5QrCode.start(
    cameraId,
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    onScanSuccess,
    () => {} // تجاهل فشل المسح
  ).then(() => {
    // محاولة الوصول إلى مسار الكاميرا للتحكم في الكشاف والتكبير
    navigator.mediaDevices.getUserMedia({
      video: { deviceId: cameraId }
    }).then(stream => {
      cameraTrack = stream.getVideoTracks()[0];
      
      // التحقق من دعم الكشاف
      if (cameraTrack && cameraTrack.getCapabilities().torch) {
        toggleFlashlightBtn.style.display = 'flex';
      } else {
        toggleFlashlightBtn.style.display = 'none';
      }
      
      // التحقق من دعم التكبير
      if (cameraTrack && cameraTrack.getCapabilities().zoom) {
        const capabilities = cameraTrack.getCapabilities();
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step;
        zoomSlider.value = currentZoom;
        document.getElementById('zoomSliderContainer').style.display = 'flex';
      } else {
        document.getElementById('zoomSliderContainer').style.display = 'none';
      }
    }).catch(e => {
      console.error("لا يمكن الوصول إلى الكاميرا للكشاف:", e);
      toggleFlashlightBtn.style.display = 'none';
      document.getElementById('zoomSliderContainer').style.display = 'none';
    });
  }).catch(err => {
    console.error("فشل في بدء المسح:", err);
    notyf.error("فشل في تشغيل الكاميرا. تأكد من منح التطبيق صلاحية استخدام الكاميرا.");
  });
}

// عند المسح الناجح
function onScanSuccess(decodedText, decodedResult) {
  console.log(`مسح BarCode: ${decodedText}`, decodedResult);
  
  // إضافة إلى سجل المسح
  addToScanHistory(decodedText);
  
  // إظهار إشعار بنجاح المسح
  notyf.success(`تم مسح الباركود: ${decodedText}`);
  
  // إظهار الإشعار العائم
  showScanNotification(decodedText);
}

// عرض إشعار المسح
function showScanNotification(barcode) {
  scanNotification.textContent = `تم مسح الباركود: ${barcode}`;
  scanNotification.style.display = 'block';
  
  setTimeout(() => {
    scanNotification.style.display = 'none';
  }, 3000);
}

// إضافة إلى سجل المسح
function addToScanHistory(barcode) {
  scanHistory.unshift({
    text: barcode,
    time: new Date().toLocaleTimeString()
  });
  
  // تحديث واجهة السجل
  updateScanHistoryUI();
}

// تحديث واجهة سجل المسح
function updateScanHistoryUI() {
  if (scanHistory.length === 0) {
    scanHistoryList.innerHTML = '<li>لا توجد عمليات مسح بعد</li>';
    return;
  }
  
  scanHistoryList.innerHTML = scanHistory.map(item => 
    `<li><strong>${item.time}</strong>: ${item.text}</li>`
  ).join('');
}

// إيقاف الماسح
function stopScanner() {
  if (html5QrCode && html5QrCode.isScanning) {
    html5QrCode.stop().then(() => {
      console.log("تم إيقاف الماسح الضوئي");
      scannerContainer.style.display = 'none';
      startScannerBtn.style.display = 'block';
      toggleFlashlightBtn.style.display = 'none';
      isFlashOn = false;
      toggleFlashlightBtn.classList.remove('active');
    }).catch(err => {
      console.error("خطأ في إيقاف الماسح:", err);
    });
  }
}

// تبديل الكشاف
function toggleFlashlight() {
  if (cameraTrack && cameraTrack.getCapabilities().torch) {
    const isFlashOn = !toggleFlashlightBtn.classList.contains('active');
    cameraTrack.applyConstraints({
      advanced: [{ torch: isFlashOn }]
    }).then(() => {
      toggleFlashlightBtn.classList.toggle('active', isFlashOn);
    }).catch(e => {
      console.error("فشل في تبديل الكشاف", e);
      notyf.error("فشل في تشغيل الكشاف.");
    });
  }
}

// التحكم في التكبير/التقريب
function handleZoomChange() {
  if (cameraTrack && cameraTrack.getCapabilities().zoom) {
    const zoomValue = parseFloat(zoomSlider.value);
    cameraTrack.applyConstraints({
      advanced: [{ zoom: zoomValue }]
    }).then(() => {
      currentZoom = zoomValue;
    }).catch(e => {
      console.error("فشل في تغيير مستوى التكبير", e);
    });
  }
}

// إضافة مستمعي الأحداث
startScannerBtn.addEventListener('click', initScanner);
closeScannerBtn.addEventListener('click', stopScanner);
toggleFlashlightBtn.addEventListener('click', toggleFlashlight);
zoomSlider.addEventListener('input', handleZoomChange);

// تهيئة أولية
scannerContainer.style.display = 'none';
toggleFlashlightBtn.style.display = 'none';
document.getElementById('zoomSliderContainer').style.display = 'none';
</script>

</body>
</html>
