<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apples-Mart - Firebase</title>

    <meta name="theme-color" content="#007bff"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* --- أنماط CSS الأساسية للتطبيق --- */
    :root {
        --primary-color: #007bff; --secondary-color: #343a40; --success-color: #28a745;
        --danger-color: #dc3545; --warning-color: #ffc107; --text-dark: #222;
        --bg-light: #f8f9fa; --white: #fff; --border-color: #dee2e6;
        --shadow-light: 0 0 6px rgba(0, 0, 0, 0.1); --whatsapp-color: #25D366;
    }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg-light); color: var(--text-dark); direction: rtl; }
    #app-container { display: none; }
    header { background: var(--primary-color); color: var(--white); padding: 15px; text-align: center; font-size: 24px; display: flex; justify-content: space-between; align-items: center; }
    nav { display: flex; background: var(--secondary-color); overflow-x: auto; }
    nav button { flex: 1; flex-shrink: 0; padding: 12px 10px; border: none; background: var(--secondary-color); color: var(--white); font-size: 16px; cursor: pointer; transition: background 0.3s; }
    nav button.active, nav button:hover { background: #0056b3; }
    nav button.hidden { display: none; }
    main { padding: 15px; max-width: 900px; margin: auto; }
    section { display: none; }
    section.active { display: block; }
    input, select, button, table { font-size: 16px; }
    input, select { width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    button { background: var(--primary-color); color: var(--white); border: none; padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
    th { background: #e9ecef; }
    .btn-small { padding: 5px 10px; font-size: 14px; margin: 0 2px; }
    .btn-danger { background: var(--danger-color); }
    .btn-success { background: var(--success-color); }
    .btn-warning { background: var(--warning-color); color: var(--text-dark); }
    .summary-box { background: var(--white); padding: 15px; margin: 15px 0; border-radius: 6px; box-shadow: var(--shadow-light); }
    #searchResults, #customerSuggestions { background: var(--white); max-height: 180px; overflow-y: auto; border: 1px solid #ccc; border-top: none; display: none; position: absolute; z-index: 1000; width: 100%; box-sizing: border-box; }
    #searchResults div, #customerSuggestions div { padding: 8px; cursor: pointer; border-bottom: 1px solid #ddd; }
    #searchResults div:hover, #customerSuggestions div:hover { background: var(--primary-color); color: var(--white); }
    .form-group { margin-bottom: 15px; }
    #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 90%; }
    .notification { background-color: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; font-size: 16px; opacity: 0; transition: opacity 0.5s ease-in-out; }
    .notification.show { opacity: 1; }
    #login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #e9ecef; }
    #login-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 350px; text-align: center; }
    #logoutBtn { background: var(--danger-color); }
    #sales-header { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 5px; }
    #sales-header .form-group { margin-bottom: 0; flex-grow: 1; min-width: 200px; position: relative; }
    #sales-header .search-group { display: flex; align-items: center; }
    #sales-header .search-group input { border-radius: 0 4px 4px 0; }
    #sales-header .search-group button { border-radius: 4px 0 0 4px; flex-shrink: 0; width: 50px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; }
    .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }

    /* --- أنماط الماسح الضوئي (Scanner) المحدثة --- */
    #scanner-container {
        display: none; /* يبدأ مخفيًا ويظهر عند الضغط على الزر */
        position: sticky; /* يجعله يلتصق بأعلى الصفحة */
        top: 0; /* تحديد الالتصاق بأعلى نقطة */
        z-index: 9998; /* ليكون فوق كل شيء ما عدا الإشعارات والمودال */
        width: 100%;
        height: 125px; /* --- تم تقليل الارتفاع للنصف --- */
        margin: 0;
        border: none;
        border-bottom: 3px solid var(--success-color);
        border-radius: 0;
        overflow: hidden;
        background-color: #222; /* خلفية أغمق */
    }
    #qr-reader {
        position: relative;
        height: 100%;
        width: 100%;
    }
    #qr-reader video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .scan-region {
        width: 60%;
        height: 60%; /* نسبة مئوية من الحاوية الجديدة الأصغر */
        border: 2px solid #4CAF50;
        border-radius: 10px;
        transition: all 0.2s ease-in-out;
    }
    .scan-region.success-flash {
        border-color: #28a745;
        box-shadow: 0 0 15px #28a745;
    }
    .scan-region.error-flash {
        border-color: #dc3545;
        box-shadow: 0 0 15px #dc3545;
    }
    #closeScannerBtn {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 10;
        background: rgba(220, 53, 69, 0.8);
        border: 1px solid white;
        width: 35px;
        height: 35px;
        padding: 0;
        border-radius: 50%;
        font-size: 18px;
    }
</style>
</head>
<body>

<div id="scanner-container">
    <div id="qr-reader"></div>
    <div class="scanner-overlay">
        <div class="scan-region"></div>
    </div>
    <button id="closeScannerBtn" title="إغلاق الماسح"><i class="fas fa-times"></i></button>
</div>

<div id="app-container">
    <header>
        <span>Apples-Mart</span>
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button>
    </header>
    <nav>
        <button data-tab="items"><i class="fas fa-box"></i> الأصناف</button>
        <button data-tab="customers"><i class="fas fa-users"></i> العملاء</button>
        <button class="active" data-tab="sales"><i class="fas fa-cash-register"></i> المبيعات</button>
        <button data-tab="invoices"><i class="fas fa-file-invoice"></i> الفواتير</button>
        <button data-tab="summary"><i class="fas fa-chart-bar"></i> التقارير</button>
        <button data-tab="users" class="hidden"><i class="fas fa-user-shield"></i> إدارة المستخدمين</button>
    </nav>

    <main>
        <section id="sales" class="active" style="position: relative;">
            <h2><i class="fas fa-cash-register"></i> عملية بيع</h2>
            <div id="sales-header">
                <div class="form-group">
                    <div class="search-group">
                        <input type="text" id="searchItem" placeholder="بحث بالاسم أو الباركود" autocomplete="off" />
                        <button id="startScannerBtn" title="فتح ماسح الكاميرا"><i class="fas fa-barcode"></i></button>
                    </div>
                    <div id="searchResults"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="customerName" placeholder="اسم العميل (اختياري)" autocomplete="off" />
                    <div id="customerSuggestions"></div>
                </div>
                <div class="form-group"><input type="tel" id="customerPhone" placeholder="رقم هاتف العميل" /></div>
            </div>
            
            <h3><i class="fas fa-file-invoice"></i> تفاصيل الفاتورة</h3>
            <table><thead><tr><th>اسم الصنف</th><th>كمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>حذف</th></tr></thead><tbody id="invoiceTable"></tbody></table>
            
            <div class="summary-box" style="padding: 10px;">
                <h3 style="text-align: left; margin: 0;">إجمالي الفاتورة: <span id="invoiceTotal">0.00</span> ج.م</span></h3>
            </div>
            <div id="sales-footer">
                <div class="sales-footer-row">
                    <div class="form-group">
                        <input type="number" id="amountPaidInput" placeholder="المبلغ المدفوع" min="0" step="0.01" />
                    </div>
                </div>
                <div class="sales-footer-row">
                    <div class="btn-group">
                        <button id="printInvoiceBtn" class="btn-success"><i class="fas fa-print"></i> طباعة</button>
                        <button id="saveInvoiceBtn"><i class="fas fa-save"></i> حفظ</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="items"><h2><i class="fas fa-box"></i> عرض الأصناف</h2><div style="overflow-x:auto;"><table><thead><tr><th>باركود 1</th><th>اسم</th><th>سعر</th><th>كمية</th><th>فئة</th></tr></thead><tbody id="itemsTable"></tbody></table></div></section>
        <section id="customers"><h2><i class="fas fa-users"></i> إدارة العملاء</h2></section>
        <section id="invoices"><h2><i class="fas fa-file-invoice-dollar"></i> الفواتير</h2></section>
        <section id="summary"><h2><i class="fas fa-chart-bar"></i> التقارير</h2></section>
        <section id="users" class="hidden"><h2><i class="fas fa-user-shield"></i> إدارة المستخدمين</h2></section>
    </main>
</div>
<div id="login-container"></div>
<div id="notification-container"></div>

<script type="module">
// #region Firebase Initialization (تبقى كما هي)
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
// ... (بقية استيرادات Firebase)
const firebaseConfig = { /* ... بياناتك ... */ };
const app = initializeApp(firebaseConfig);
// ... (بقية إعدادات Firebase)
// #endregion

// #region Global Variables and DOM Elements
const DOM = {
    // ... (كل عناصر DOM كما هي)
    appContainer: document.getElementById("app-container"),
    loginContainer: document.getElementById("login-container"),
    startScannerBtn: document.getElementById("startScannerBtn"),
    scannerContainer: document.getElementById("scanner-container"),
    closeScannerBtn: document.getElementById("closeScannerBtn"),
    invoiceTable: document.getElementById("invoiceTable"),
    itemsTable: document.getElementById("itemsTable"),
    invoiceTotal: document.getElementById("invoiceTotal"),
    amountPaidInput: document.getElementById("amountPaidInput"),
    saveInvoiceBtn: document.getElementById("saveInvoiceBtn"),
    printInvoiceBtn: document.getElementById("printInvoiceBtn"),
    searchItem: document.getElementById("searchItem"),
    searchResults: document.getElementById("searchResults"),
    // ... أضف بقية العناصر الضرورية هنا
};

let appState = {
    items: [],
    currentInvoice: [],
    html5QrCode: null,
    // ... (بقية متغيرات الحالة)
};
// #endregion

// #region Helper & Utility Functions
const Helpers = {
    showNotification: (message, duration = 3000) => { /* ... (كما هي) */ },
    // ... (بقية الدوال المساعدة)
};
// #endregion

// #region Controllers (Sales, Items, etc.)
const SalesController = {
    updateTotals: () => {
        const itemsTotal = appState.currentInvoice.reduce((sum, item) => sum + (item.price * item.qty), 0);
        DOM.invoiceTotal.textContent = itemsTotal.toFixed(2);
    },
    renderInvoice: () => {
        DOM.invoiceTable.innerHTML = appState.currentInvoice.map((item, index) => `<tr><td>${item.name}</td><td>${item.qty}</td><td>${(item.price || 0).toFixed(2)}</td><td>${((item.price || 0) * item.qty).toFixed(2)}</td><td><button class="btn-small btn-danger remove-from-invoice-btn" data-index="${index}"><i class="fas fa-trash-alt"></i></button></td></tr>`).join("");
        SalesController.updateTotals();
    },
    addToInvoice: (item) => {
        const existing = appState.currentInvoice.find(i => i.id === item.id);
        if (existing) {
            existing.qty++;
        } else {
            appState.currentInvoice.push({ ...item, qty: 1 });
        }
        SalesController.renderInvoice();
    },
    // ... (بقية دوال المبيعات)
};

const ItemsController = {
    render: () => {
        // هذه الدالة تملأ جدول الأصناف في تبويب "الأصناف"
        DOM.itemsTable.innerHTML = appState.items.map(item => `
            <tr>
                <td>${item.barcode1}</td>
                <td>${item.name || 'غير متوفر'}</td>
                <td>${(item.price || 0).toFixed(2)}</td>
                <td>${item.qunt || 0}</td>
                <td>${item.category || 'غير محدد'}</td>
            </tr>
        `).join("");
    }
    // ... (بقية دوال الأصناف)
};
// #endregion

// #region Scanner Controller (مُحدث بالكامل)
const ScannerController = {
    onScanSuccess: (decodedText, decodedResult) => {
        const cleanDecodedText = decodedText.trim();
        const scanRegion = document.querySelector('.scan-region');

        const product = appState.items.find(p =>
            String(p.sku || '').trim() === cleanDecodedText ||
            String(p.barcode1 || '').trim() === cleanDecodedText ||
            String(p.barcode2 || '').trim() === cleanDecodedText
        );

        if (appState.html5QrCode && appState.html5QrCode.isScanning) {
            appState.html5QrCode.pause();
            setTimeout(() => {
                if (appState.html5QrCode) appState.html5QrCode.resume();
            }, 1500);
        }

        if (product) {
            scanRegion.classList.add('success-flash');
            setTimeout(() => scanRegion.classList.remove('success-flash'), 500);
            
            // --- هنا يتم إضافة المنتج للفاتورة مباشرة ---
            SalesController.addToInvoice(product);
            
            Helpers.showNotification(`✅ تمت إضافة: ${product.name}`);
        } else {
            scanRegion.classList.add('error-flash');
            setTimeout(() => scanRegion.classList.remove('error-flash'), 500);
            Helpers.showNotification(`❌ الصنف غير موجود للباركود: ${cleanDecodedText}`);
        }
    },

    start: () => {
        if (!appState.html5QrCode) {
            appState.html5QrCode = new Html5Qrcode("qr-reader", { formatsToSupport: [Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.EAN_8] });
        }
        
        DOM.scannerContainer.style.display = 'block';
        
        const config = { fps: 10, qrbox: { width: 250, height: 50 } }; // تم تعديل ارتفاع منطقة البحث

        appState.html5QrCode.start(
            { facingMode: "environment" },
            config,
            ScannerController.onScanSuccess,
            (errorMessage) => { /* تجاهل */ }
        )
        .catch((err) => {
            Helpers.showNotification("❌ فشل تشغيل الكاميرا. يرجى منح الإذن.");
            ScannerController.stop();
        });
    },

    stop: () => {
        if (appState.html5QrCode && appState.html5QrCode.isScanning) {
            appState.html5QrCode.stop().catch(err => console.error("Scanner stop failed", err));
        }
        DOM.scannerContainer.style.display = 'none';
    }
};
// #endregion

// #region App Logic & Event Listeners
const App = {
    init: () => {
        // ... (كود الـ init كما هو)
        App.loadItemsFromJSON(); // التأكد من تحميل البيانات عند البدء
        App.bindEvents();
    },

    loadItemsFromJSON: async () => {
        try {
            const response = await fetch('p.json');
            if (!response.ok) throw new Error('فشل تحميل ملف الأصناف');
            const itemsData = await response.json();
            appState.items = itemsData.map(item => ({
                ...item,
                id: String(item.barcode1 || item.sku || ''),
                price: parseFloat(item.price) || 0,
                qunt: parseInt(item.qunt) || 0
            }));

            // --- هنا يتم ملء جدول الأصناف بالبيانات ---
            ItemsController.render();
            Helpers.showNotification("تم تحميل الأصناف بنجاح.");
        } catch (error) {
            Helpers.showNotification("خطأ: لم يتم العثور على ملف الأصناف p.json");
        }
    },
    
    bindEvents: () => {
        // ... (كل الـ Event Listeners الأخرى كما هي)

        // --- ربط أحداث الماسح الضوئي ---
        DOM.startScannerBtn.addEventListener("click", ScannerController.start);
        DOM.closeScannerBtn.addEventListener("click", ScannerController.stop);
        
        DOM.invoiceTable.addEventListener("click", (e) => {
            const btn = e.target.closest(".remove-from-invoice-btn");
            if (btn) {
                const index = parseInt(btn.dataset.index);
                appState.currentInvoice.splice(index, 1);
                SalesController.renderInvoice();
            }
        });
    }
};

// بدء تشغيل التطبيق
App.init();

// يمكنك إزالة قسم تسجيل الدخول مؤقتا لتسهيل الاختبار
document.getElementById("app-container").style.display = "block";
document.getElementById("login-container").style.display = "none";
</script>
</body>
</html>
