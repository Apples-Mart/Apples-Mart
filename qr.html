<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماسح الباركود</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }

        #scanner-container {
            position: relative;
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        #qr-reader {
            width: 100%;
            border-radius: 8px;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .scan-region {
            width: 80%;
            height: 40%;
            border: 3px solid #4CAF50;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        .controls {
            text-align: center;
            margin: 10px 0;
        }

        #results-container {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            text-align: right;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f7f7f7;
        }

        .quantity-controls button {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        #close-scanner-btn {
            display: block;
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="scanner-container">
        <div id="qr-reader"></div>
        <div class="scanner-overlay">
            <div class="scan-region"></div>
        </div>
    </div>

    <div class="controls">
        <label for="zoom-slider">تقريب:</label>
        <input id="zoom-slider" type="range" min="1" max="5" step="0.1" value="1">
    </div>

    <div id="results-container">
        <h2>النتائج</h2>
        <table id="results-table">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الكمية</th>
                    <th>سعر الوحدة</th>
                    <th>المجموع الجزئي</th>
                    <th>حذف</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <button id="close-scanner-btn">إغلاق الماسح</button>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // تحميل ملفات الصوت
            const successSound = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2b28b2b93d.mp3');
            const failSound = new Audio('https://cdn.pixabay.com/audio/2022/11/10/audio_c89b3f4e3c.mp3');

            let productsData = []; // سيتم ملؤه من ملف JSON
            const scannedProducts = new Map();
            
            // --- جلب بيانات المنتجات من ملف p.json ---
            fetch('p.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('فشل تحميل الملف: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    productsData = data;
                    console.log("تم تحميل المنتجات بنجاح من p.json");
                })
                .catch(error => {
                    console.error('حدث خطأ أثناء جلب ملف المنتجات:', error);
                    alert('فشل تحميل ملف المنتجات p.json. تأكد من وجود الملف في نفس المسار وأنه بصيغة JSON صحيحة.');
                });
            // -------------------------------------------

            const html5QrCode = new Html5Qrcode("qr-reader");

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                // تأكد من أن بيانات المنتجات قد تم تحميلها أولاً
                if (productsData.length === 0) {
                    console.warn("بيانات المنتجات لم تحمل بعد، يرجى الانتظار.");
                    failSound.play();
                    return;
                }

                const product = findProductByBarcode(decodedText);

                if (product) {
                    successSound.play();
                    addProductToTable(product);
                    html5QrCode.pause();
                    setTimeout(() => html5QrCode.resume(), 1500);
                } else {
                    failSound.play();
                    console.warn(`الباركود ${decodedText} غير موجود في قاعدة البيانات.`);
                }
            };

            const config = { fps: 10, qrbox: { width: 250, height: 150 } };

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id;
                    html5QrCode.start(
                        cameraId,
                        config,
                        qrCodeSuccessCallback,
                        (errorMessage) => {}
                    ).catch((err) => {
                        console.error("فشل في تشغيل الكاميرا:", err);
                    });
                }
            }).catch(err => {
                console.error("لا يمكن الوصول للكاميرات:", err);
            });

            const zoomSlider = document.getElementById('zoom-slider');
            zoomSlider.addEventListener('input', (e) => {
                const videoTrack = document.querySelector('#qr-reader video')?.srcObject?.getVideoTracks()[0];
                if (!videoTrack) return;
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.zoom) {
                    videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(e.target.value) }] });
                } else {
                    console.warn('التقريب غير مدعوم.');
                }
            });

            document.getElementById('close-scanner-btn').addEventListener('click', () => {
                html5QrCode.stop().then(() => {
                    console.log("تم إيقاف الماسح.");
                    alert("تم إغلاق الماسح الضوئي.");
                }).catch(err => console.error("فشل إيقاف الماسح:", err));
            });

            function findProductByBarcode(barcode) {
                return productsData.find(p => p.barcode1 === barcode || p.barcode2 === barcode || p.sku === barcode);
            }

            function addProductToTable(product) {
                const tableBody = document.getElementById('results-table').getElementsByTagName('tbody')[0];
                const productKey = product.sku;

                if (scannedProducts.has(productKey)) {
                    const existingProduct = scannedProducts.get(productKey);
                    existingProduct.quantity++;
                    const row = document.getElementById(`row-${productKey}`);
                    row.cells[1].querySelector('.quantity-display').textContent = existingProduct.quantity;
                    updateSubtotal(row, existingProduct.quantity, product.price);
                } else {
                    const quantity = 1;
                    scannedProducts.set(productKey, { ...product, quantity });
                    const newRow = tableBody.insertRow();
                    newRow.id = `row-${productKey}`;
                    newRow.innerHTML = `
                        <td>${product.name}</td>
                        <td>
                            <div class="quantity-controls">
                                <button class="quantity-btn minus-btn" data-key="${productKey}">-</button>
                                <span class="quantity-display">${quantity}</span>
                                <button class="quantity-btn plus-btn" data-key="${productKey}">+</button>
                            </div>
                        </td>
                        <td>${product.price.toFixed(2)}</td>
                        <td class="subtotal">${(quantity * product.price).toFixed(2)}</td>
                        <td><button class="delete-btn" data-key="${productKey}">حذف</button></td>
                    `;
                }
            }

            document.getElementById('results-table').addEventListener('click', (e) => {
                const target = e.target;
                const productKey = target.dataset.key;
                if (!productKey) return;
                const productInfo = scannedProducts.get(productKey);
                const row = document.getElementById(`row-${productKey}`);
                if (target.classList.contains('plus-btn')) {
                    productInfo.quantity++;
                } else if (target.classList.contains('minus-btn')) {
                    if (productInfo.quantity > 1) productInfo.quantity--;
                } else if (target.classList.contains('delete-btn')) {
                    row.remove();
                    scannedProducts.delete(productKey);
                    return;
                }
                row.cells[1].querySelector('.quantity-display').textContent = productInfo.quantity;
                updateSubtotal(row, productInfo.quantity, productInfo.price);
            });

            function updateSubtotal(row, quantity, price) {
                row.cells[3].textContent = (quantity * price).toFixed(2);
            }
        });
    </script>
</body>
</html>
