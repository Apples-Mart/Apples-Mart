<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#007bff"/>
<title>Apples-Mart - ماسح الباركود المحسن</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* تحسينات خاصة بالماسح الضوئي */
  #scanner-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.95);
    z-index: 10001;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
  }
  
  #scanner-header {
    color: white;
    text-align: center;
    margin-bottom: 15px;
    width: 100%;
    max-width: 500px;
  }
  
  #scanner-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .scanner-btn {
    background: rgba(255,255,255,0.1);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
  }
  
  .scanner-btn:hover {
    background: rgba(255,255,255,0.2);
  }
  
  #reader {
    width: 90%;
    max-width: 500px;
    height: 220px; /* ارتفاع أقل ليكون مستطيلاً أكثر */
    background: #000;
    overflow: hidden;
    position: relative;
    border: 2px solid #4db8ff;
    box-shadow: 0 0 20px rgba(77, 184, 255, 0.5);
  }
  
  #reader::after {
    content: '';
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    height: 3px;
    background: #ff4747;
    box-shadow: 0 0 10px #ff4747;
    animation: laser-beam 2s infinite linear;
    border-radius: 3px;
  }
  
  #scanner-guide {
    color: white;
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
    max-width: 500px;
    line-height: 1.5;
    background: rgba(0,0,0,0.6);
    padding: 12px;
    border-radius: 8px;
  }
  
  #scanner-guide h3 {
    margin-top: 0;
    color: #4db8ff;
    font-size: 16px;
    margin-bottom: 8px;
  }
  
  #scanner-guide ul {
    text-align: right;
    padding-right: 15px;
    margin: 0;
  }
  
  #scanner-guide li {
    margin-bottom: 5px;
  }
  
  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.6);
    padding: 6px 12px;
    border-radius: 18px;
    margin-top: 8px;
  }
  
  .zoom-btn {
    background: none;
    border: 1px solid white;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
  }
  
  .zoom-value {
    color: white;
    font-size: 14px;
    min-width: 40px;
    text-align: center;
  }
  
  @keyframes laser-beam {
    0% { transform: translateY(5px); }
    50% { transform: translateY(calc(100% - 5px)); }
    100% { transform: translateY(5px); }
  }
  
  @media (max-width: 768px) {
    #reader {
      height: 200px;
    }
    
    #scanner-controls {
      flex-direction: row;
    }
    
    .scanner-btn {
      width: auto;
    }
    
    #scanner-guide {
      font-size: 13px;
    }
  }

  @media (max-width: 480px) {
    #reader {
      height: 180px;
    }
    
    .scanner-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>

<div id="app-container">
  <!-- باقي المحتوى الأصلي -->
  <section id="sales" class="active" style="position: relative;">
    <!-- محتوى قسم المبيعات الأصلي -->
    <div id="sales-header">
      <div class="form-group">
        <div class="search-group">
          <input type="text" id="searchItem" placeholder="بحث بالاسم أو الباركود" autocomplete="off" />
          <button id="startScannerBtn" title="فتح ماسح الكاميرا (SKU)">
            <i class="fas fa-barcode"></i>
          </button>
        </div>
        <div id="searchResults"></div>
      </div>
      <!-- باقي عناصر واجهة المبيعات -->
    </div>
  </section>
</div>

<!-- نافذة الماسح الضوئي المحسنة -->
<div id="scanner-container">
  <div id="scanner-header">
    <h2><i class="fas fa-barcode"></i> ماسح الباركود</h2>
    <p>وجّه الكاميرا نحو الباركود للتعرف عليه تلقائياً</p>
  </div>
  
  <div id="scanner-controls">
    <button id="toggleTorchBtn" class="scanner-btn">
      <i class="fas fa-lightbulb"></i> ضوء
    </button>
    
    <button id="closeScannerBtn" class="scanner-btn" style="background: #dc3545;">
      <i class="fas fa-times"></i> إغلاق
    </button>
  </div>
  
  <div id="reader"></div>
  
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomOutBtn">-</button>
    <span class="zoom-value" id="zoomLevel">1.0x</span>
    <button class="zoom-btn" id="zoomInBtn">+</button>
  </div>
  
  <div id="scanner-guide">
    <h3><i class="fas fa-lightbulb"></i> نصائح للمسح الأمثل:</h3>
    <ul>
      <li>أبقِ الكاميرا على بعد 5-30 سم من الباركود</li>
      <li>تأكد من وجود إضاءة كافية على الباركود</li>
      <li>حاول إبقاء الكاميرا ثابتة أثناء المسح</li>
      <li>استخدم أزرار التكبير/التصغير لتحسين الدقة</li>
    </ul>
  </div>
</div>

<script>
// حالة التطبيق
const appState = {
  items: [],
  currentInvoice: []
};

// تهيئة الماسح الضوئي مع تحسينات للكود الصغير
function initScanner() {
  if (!window.scanner) {
    window.scanner = new Html5Qrcode("reader");
  }
  
  // استخدام الكاميرا الخلفية دائمًا
  const constraints = {
    facingMode: "environment" // الكاميرا الخلفية فقط
  };
  
  const config = {
    fps: 15,
    qrbox: {
      width: 250,  // منطقة مسح أوسع للكود الطويل
      height: 80   // ارتفاع أقل للتركيز على الكود المستطيل
    },
    aspectRatio: 1.5,
    focusMode: "continuous"
  };
  
  window.scanner.start(
    constraints,
    config,
    onScanSuccess,
    onScanFailure
  ).then(() => {
    // محاولة تفعيل الضوء إذا كان متاحًا
    try {
      if (window.scanner && window.scanner.getRunningTrackCapabilities) {
        const capabilities = window.scanner.getRunningTrackCapabilities();
        if (capabilities && capabilities.torch) {
          document.getElementById('toggleTorchBtn').style.display = 'flex';
        } else {
          document.getElementById('toggleTorchBtn').style.display = 'none';
        }
      }
    } catch (e) {
      console.log("الضوء غير متاح في هذه الكاميرا");
      document.getElementById('toggleTorchBtn').style.display = 'none';
    }
  }).catch(err => {
    console.error("فشل تشغيل الماسح:", err);
    alert("تعذر الوصول إلى الكاميرا. تأكد من منح التطبيق صلاحية استخدام الكاميرا.");
  });
}

// التحكم في ضوء الكاميرا (الفلاتش)
document.getElementById('toggleTorchBtn').addEventListener('click', function() {
  if (window.scanner && window.scanner.applyVideoConstraints) {
    isTorchOn = !isTorchOn;
    try {
      window.scanner.applyVideoConstraints({
        advanced: [{ torch: isTorchOn }]
      });
      this.innerHTML = isTorchOn ? 
        '<i class="fas fa-lightbulb"></i> إيقاف الضوء' : 
        '<i class="fas fa-lightbulb"></i> تشغيل الضوء';
    } catch (e) {
      console.log("التحكم في الضوء غير متاح");
    }
  }
});

// التحكم في التكبير/التصغير
let scannerZoom = 1.0;
document.getElementById('zoomInBtn').addEventListener('click', function() {
  if (scannerZoom < 3.0) {
    scannerZoom += 0.1;
    updateZoom();
  }
});

document.getElementById('zoomOutBtn').addEventListener('click', function() {
  if (scannerZoom > 1.0) {
    scannerZoom -= 0.1;
    updateZoom();
  }
});

function updateZoom() {
  document.getElementById('zoomLevel').textContent = scannerZoom.toFixed(1) + 'x';
  
  if (window.scanner && window.scanner.applyVideoConstraints) {
    try {
      window.scanner.applyVideoConstraints({
        advanced: [{ zoom: scannerZoom }]
      });
    } catch (e) {
      console.log("التحكم في التكبير غير متاح");
    }
  }
}

// إغلاق الماسح
document.getElementById('closeScannerBtn').addEventListener('click', function() {
  stopScanner();
});

function stopScanner() {
  if (window.scanner && window.scanner.isScanning) {
    window.scanner.stop().then(() => {
      document.getElementById('scanner-container').style.display = 'none';
    }).catch(err => {
      console.error("خطأ في إيقاف الماسح:", err);
    });
  } else {
    document.getElementById('scanner-container').style.display = 'none';
  }
}

// عند النقر خارج منطقة الماسح
document.getElementById('scanner-container').addEventListener('click', function(e) {
  if (e.target === this) {
    stopScanner();
  }
});

// فتح الماسح من الزر الرئيسي
document.getElementById('startScannerBtn').addEventListener('click', function() {
  document.getElementById('scanner-container').style.display = 'flex';
  initScanner();
});

// دالة عند نجاح المسح
function onScanSuccess(decodedText, decodedResult) {
  // البحث عن المنتج باستخدام النص الممسوح
  const product = appState.items.find(p => 
    p.sku === decodedText || p.barcode1 === decodedText || p.barcode2 === decodedText
  );
  
  if (product) {
    // إضافة المنتج إلى الفاتورة
    addToInvoice(product);
    showNotification(`تمت إضافة: ${product.name}`);
    
    // إيقاف الماسح بعد المسح الناجح
    setTimeout(stopScanner, 1000);
  } else {
    showNotification("الصنف غير موجود بهذا الباركود.");
  }
}

// دالة عند فشل المسح
function onScanFailure(error) {
  // يمكن استخدام هذا للتصحيح، ولكن لا داعي لعرض كل الأخطاء
}

// وظيفة إضافة عنصر إلى الفاتورة
function addToInvoice(item) {
  const existing = appState.currentInvoice.find(i => i.id === item.id);
  const stockItem = appState.items.find(i => i.id === item.id);
  
  if (!stockItem || stockItem.qunt <= 0) {
    showNotification("المخزون غير متوفر.");
    return;
  }
  
  if (existing) {
    if (stockItem.qunt > existing.qty) {
      existing.qty++;
    } else {
      showNotification(`أقصى كمية: ${stockItem.qunt}`);
      return;
    }
  } else {
    appState.currentInvoice.push({ ...item, qty: 1 });
  }
  
  renderInvoice();
}

// وظيفة عرض الإشعارات
function showNotification(message, duration = 3000) {
  // تنفيذ عرض الإشعار هنا
  console.log(message);
  alert(message); // يمكن استبدال هذا بتنفيذ أفضل لعرض الإشعارات
}

// وظيفة عرض الفاتورة
function renderInvoice() {
  // تنفيذ عرض الفاتورة هنا
  console.log("يتم تحديث الفاتورة:", appState.currentInvoice);
}

// تحميل العناصر من ملف JSON
async function loadItemsFromJSON() {
  try {
    const response = await fetch('p.json');
    if (!response.ok) {
      throw new Error('فشل في تحميل ملف الأصناف');
    }
    const itemsData = await response.json();
    appState.items = itemsData.map(item => ({
      ...item,
      id: String(item.barcode1 || item.id || ''),
      price: parseFloat(item.price) || 0,
      qunt: parseInt(item.qunt) || 0
    }));
    
    showNotification("تم تحميل الأصناف بنجاح");
    console.log("تم تحميل العناصر:", appState.items);
  } catch (error) {
    console.error("Error loading items from JSON:", error);
    showNotification("خطأ في تحميل ملف الأصناف");
  }
}

// تحميل العناصر عند بدء التطبيق
document.addEventListener('DOMContentLoaded', function() {
  loadItemsFromJSON();
});
</script>

</body>
</html>