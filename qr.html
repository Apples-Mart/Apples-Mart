<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#007bff"/>
<title>Apples-Mart - ماسح الباركود المحسن</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* تحسينات خاصة بالماسح الضوئي */
  #scanner-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    z-index: 10001;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  #scanner-header {
    color: white;
    text-align: center;
    margin-bottom: 20px;
    width: 100%;
    max-width: 500px;
  }
  
  #scanner-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .scanner-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .scanner-btn:hover {
    background: rgba(255,255,255,0.3);
  }
  
  #reader {
    width: 90%;
    max-width: 500px;
    height: 300px;
    background: #000;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    overflow: hidden;
    position: relative;
  }
  
  #reader::after {
    content: '';
    position: absolute;
    top: 0;
    left: 5%;
    right: 5%;
    height: 2px;
    background: #ff4747;
    box-shadow: 0 0 5px #ff4747, 0 0 10px #ff4747;
    animation: laser-beam 2.5s infinite linear;
    border-radius: 2px;
  }
  
  #scanner-guide {
    color: white;
    text-align: center;
    margin-top: 20px;
    font-size: 16px;
    max-width: 500px;
    line-height: 1.6;
    background: rgba(0,0,0,0.5);
    padding: 15px;
    border-radius: 10px;
  }
  
  #scanner-guide h3 {
    margin-top: 0;
    color: #4db8ff;
  }
  
  #scanner-guide ul {
    text-align: right;
    padding-right: 20px;
  }
  
  #scanner-guide li {
    margin-bottom: 8px;
  }
  
  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.5);
    padding: 8px 15px;
    border-radius: 20px;
    margin-top: 10px;
  }
  
  .zoom-btn {
    background: none;
    border: 1px solid white;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
  }
  
  .zoom-value {
    color: white;
    font-size: 16px;
    min-width: 50px;
    text-align: center;
  }
  
  @keyframes laser-beam {
    0% { transform: translateY(10px); }
    50% { transform: translateY(calc(100% - 10px)); }
    100% { transform: translateY(10px); }
  }
  
  @media (max-width: 768px) {
    #reader {
      height: 250px;
    }
    
    #scanner-controls {
      flex-direction: column;
      align-items: center;
    }
    
    .scanner-btn {
      width: 200px;
      justify-content: center;
    }
  }
</style>
</head>
<body>

<div id="app-container">
  <!-- باقي المحتوى الأصلي -->
  <section id="sales" class="active" style="position: relative;">
    <!-- محتوى قسم المبيعات الأصلي -->
    <div id="sales-header">
      <div class="form-group">
        <div class="search-group">
          <input type="text" id="searchItem" placeholder="بحث بالاسم أو الباركود" autocomplete="off" />
          <button id="startScannerBtn" title="فتح ماسح الكاميرا (SKU)">
            <i class="fas fa-barcode"></i>
          </button>
        </div>
        <div id="searchResults"></div>
      </div>
      <!-- باقي عناصر واجهة المبيعات -->
    </div>
  </section>
</div>

<!-- نافذة الماسح الضوئي المحسنة -->
<div id="scanner-container">
  <div id="scanner-header">
    <h2><i class="fas fa-barcode"></i> ماسح الباركود</h2>
    <p>وجّه الكاميرا نحو الباركود للتعرف عليه تلقائياً</p>
  </div>
  
  <div id="scanner-controls">
    <button id="switchCameraBtn" class="scanner-btn">
      <i class="fas fa-camera-rotate"></i> تبديل الكاميرا
    </button>
    
    <button id="toggleTorchBtn" class="scanner-btn">
      <i class="fas fa-lightbulb"></i> ضوء
    </button>
    
    <button id="closeScannerBtn" class="scanner-btn" style="background: #dc3545;">
      <i class="fas fa-times"></i> إغلاق
    </button>
  </div>
  
  <div id="reader"></div>
  
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomOutBtn">-</button>
    <span class="zoom-value" id="zoomLevel">1.0x</span>
    <button class="zoom-btn" id="zoomInBtn">+</button>
  </div>
  
  <div id="scanner-guide">
    <h3><i class="fas fa-lightbulb"></i> نصائح للمسح الأمثل:</h3>
    <ul>
      <li>أبقِ الكاميرا على بعد 5-30 سم من الباركود</li>
      <li>تأكد من وجود إضاءة كافية على الباركود</li>
      <li>حاول إبقاء الكاميرا ثابتة أثناء المسح</li>
      <li>استخدم أزرار التكبير/التصغير لتحسين الدقة</li>
    </ul>
  </div>
</div>

<script>
// متغيرات التحكم بالماسح الضوئي
let scannerZoom = 1.0;
let isTorchOn = false;
let currentCameraId = null;
let cameras = [];

// تهيئة الماسح الضوئي مع تحسينات للكود الصغير
function initScanner() {
  if (!window.scanner) {
    window.scanner = new Html5Qrcode("reader");
  }
  
  // الحصول على قائمة الكاميرات المتاحة
  Html5Qrcode.getCameras().then(devices => {
    cameras = devices;
    if (cameras.length > 0) {
      // نبدأ بالكاميرا الخلفية إن وجدت
      const backCamera = cameras.find(cam => cam.label.toLowerCase().includes('back'));
      currentCameraId = backCamera ? backCamera.id : cameras[0].id;
      startScanner(currentCameraId);
    }
  }).catch(err => {
    console.error("خطأ في الحصول على الكاميرات:", err);
    startScanner(); // استخدام الإعدادات الافتراضية
  });
}

// بدء تشغيل الماسح مع إعدادات محسنة للأكواد الصغيرة
function startScanner(cameraId = null) {
  const config = {
    fps: 15, // زيادة معدل الأطراف للكشف الأسرع
    qrbox: {
      width: 200,  // منطقة مسح أصغر للتركيز على التفاصيل الدقيقة
      height: 100
    },
    aspectRatio: 1.5, // نسبة أبعاد للمساحة المستطيلة
    focusMode: "continuous" // وضع التركيز المستمر
  };
  
  let scannerConfig = config;
  
  // إذا كان المتصفح يدوى Zoom API
  if (window.scanner && 'applyVideoConstraints' in window.scanner) {
    scannerConfig = {
      ...config,
      videoConstraints: {
        ...(cameraId && { deviceId: { exact: cameraId } }),
        width: { min: 1280, ideal: 1920 }, // دقة عالية للكشف عن التفاصيل الدقيقة
        height: { min: 720, ideal: 1080 },
        zoom: scannerZoom
      }
    };
  }
  
  window.scanner.start(
    cameraId || { facingMode: "environment" },
    scannerConfig,
    onScanSuccess,
    onScanFailure
  ).then(() => {
    // محاولة تفعيل الضوء إذا كان متاحًا
    if (window.scanner && window.scanner.getRunningTrackCapabilities) {
      try {
        const capabilities = window.scanner.getRunningTrackCapabilities();
        if (capabilities && capabilities.torch) {
          document.getElementById('toggleTorchBtn').style.display = 'flex';
        }
      } catch (e) {
        console.log("الضوء غير متاح في هذه الكاميرا");
      }
    }
  }).catch(err => {
    console.error("فشل تشغيل الماسح:", err);
    alert("تعذر الوصول إلى الكاميرا. تأكد من منح التطبيق صلاحية استخدام الكاميرا.");
  });
}

// تبديل الكاميرا الأمامية/الخلفية
document.getElementById('switchCameraBtn').addEventListener('click', function() {
  if (cameras.length < 2) {
    alert("لم يتم العثور على كاميرا أخرى");
    return;
  }
  
  const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
  const nextIndex = (currentIndex + 1) % cameras.length;
  currentCameraId = cameras[nextIndex].id;
  
  window.scanner.stop().then(() => {
    startScanner(currentCameraId);
  }).catch(err => {
    console.error("خطأ في تبديل الكاميرا:", err);
  });
});

// التحكم في ضوء الكاميرا (الفلاتش)
document.getElementById('toggleTorchBtn').addEventListener('click', function() {
  if (window.scanner && window.scanner.applyVideoConstraints) {
    isTorchOn = !isTorchOn;
    try {
      window.scanner.applyVideoConstraints({
        advanced: [{ torch: isTorchOn }]
      });
      this.innerHTML = isTorchOn ? 
        '<i class="fas fa-lightbulb"></i> إيقاف الضوء' : 
        '<i class="fas fa-lightbulb"></i> تشغيل الضوء';
    } catch (e) {
      console.log("التحكم في الضوء غير متاح");
    }
  }
});

// التحكم في التكبير/التصغير
document.getElementById('zoomInBtn').addEventListener('click', function() {
  if (scannerZoom < 3.0) {
    scannerZoom += 0.1;
    updateZoom();
  }
});

document.getElementById('zoomOutBtn').addEventListener('click', function() {
  if (scannerZoom > 1.0) {
    scannerZoom -= 0.1;
    updateZoom();
  }
});

function updateZoom() {
  document.getElementById('zoomLevel').textContent = scannerZoom.toFixed(1) + 'x';
  
  if (window.scanner && window.scanner.applyVideoConstraints) {
    try {
      window.scanner.applyVideoConstraints({
        advanced: [{ zoom: scannerZoom }]
      });
    } catch (e) {
      console.log("التحكم في التكبير غير متاح");
    }
  }
}

// إغلاق الماسح
document.getElementById('closeScannerBtn').addEventListener('click', function() {
  stopScanner();
});

function stopScanner() {
  if (window.scanner && window.scanner.isScanning) {
    window.scanner.stop().then(() => {
      document.getElementById('scanner-container').style.display = 'none';
      isTorchOn = false;
    }).catch(err => {
      console.error("خطأ في إيقاف الماسح:", err);
    });
  } else {
    document.getElementById('scanner-container').style.display = 'none';
  }
}

// عند النقر خارج منطقة الماسح
document.getElementById('scanner-container').addEventListener('click', function(e) {
  if (e.target === this) {
    stopScanner();
  }
});

// فتح الماسح من الزر الرئيسي
document.getElementById('startScannerBtn').addEventListener('click', function() {
  document.getElementById('scanner-container').style.display = 'flex';
  initScanner();
});

// دالة عند نجاح المسح
function onScanSuccess(decodedText, decodedResult) {
  // البحث عن المنتج باستخدام النص الممسوح
  const product = appState.items.find(p => 
    p.sku === decodedText || p.barcode1 === decodedText || p.barcode2 === decodedText
  );
  
  if (product) {
    // إضافة المنتج إلى الفاتورة
    SalesController.addToInvoice(product);
    Helpers.showNotification(`تمت إضافة: ${product.name}`);
    
    // إيقاف الماسح بعد المسح الناجح
    setTimeout(stopScanner, 1000);
  } else {
    Helpers.showNotification("الصنف غير موجود بهذا الباركود.");
  }
}

// دالة عند فشل المسح
function onScanFailure(error) {
  // يمكن استخدام هذا للتصحيح، ولكن لا داعي لعرض كل الأخطاء
  // console.warn(`خطأ في المسح: ${error}`);
}

// إظهار وإخفاء دليل المسح حسب الحاجة
setTimeout(() => {
  const guide = document.getElementById('scanner-guide');
  if (guide) {
    guide.style.display = 'block';
    
    // إخفاء الدليل بعد 10 ثواني
    setTimeout(() => {
      guide.style.opacity = '1';
      setTimeout(() => {
        guide.style.transition = 'opacity 1s';
        guide.style.opacity = '0';
        setTimeout(() => {
          guide.style.display = 'none';
        }, 1000);
      }, 10000);
    }, 100);
  }
}, 500);
</script>

</body>
</html>